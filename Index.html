<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reading Tracker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #f4f3f0;
      --surface: #ffffff;
      --border: #e4e2dd;
      --border-focus: #5046e5;
      --accent: #5046e5;
      --accent-light: #ededfc;
      --accent-glow: rgba(80, 70, 229, 0.15);
      --text: #1a1a1a;
      --text-secondary: #6b6b6b;
      --text-dim: #9e9e9e;
      --success: #16a06e;
      --success-bg: #edf8f3;
      --success-border: #c8eddb;
      --error: #dc3545;
      --error-bg: #fdf0f1;
      --error-border: #f5c6cb;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Urbanist', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 24px 16px;
      -webkit-font-smoothing: antialiased;
    }

    .container { width: 100%; max-width: 480px; }

    .header { text-align: center; padding: 32px 0 36px; }
    .header-icon {
      width: 56px; height: 56px; background: var(--accent-light);
      border-radius: 16px; display: inline-flex; align-items: center;
      justify-content: center; font-size: 26px; margin-bottom: 18px;
    }
    .header h1 { font-size: 28px; font-weight: 800; letter-spacing: -0.5px; margin-bottom: 4px; }
    .header p { color: var(--text-secondary); font-size: 15px; font-weight: 500; }

    .card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 16px; padding: 24px; margin-bottom: 14px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }
    .card-title {
      font-size: 11px; font-weight: 800; text-transform: uppercase;
      letter-spacing: 1.4px; color: var(--text-dim); margin-bottom: 18px;
    }

    .book-selector { position: relative; }
    .book-selector select {
      width: 100%; padding: 13px 44px 13px 16px; background: var(--bg);
      border: 1.5px solid var(--border); border-radius: 10px; color: var(--text);
      font-family: 'Urbanist', sans-serif; font-size: 15px; font-weight: 600;
      appearance: none; cursor: pointer; transition: border-color 0.2s, box-shadow 0.2s;
    }
    .book-selector select:focus { outline: none; border-color: var(--border-focus); box-shadow: 0 0 0 3px var(--accent-glow); }
    .book-selector::after {
      content: '‚ñæ'; position: absolute; right: 16px; top: 50%;
      transform: translateY(-50%); color: var(--text-secondary); pointer-events: none;
    }

    .book-info { display: flex; gap: 10px; margin-top: 14px; flex-wrap: wrap; }
    .info-chip {
      display: inline-flex; align-items: center; gap: 5px; padding: 5px 11px;
      background: var(--bg); border: 1px solid var(--border); border-radius: 8px;
      font-size: 13px; font-weight: 500; color: var(--text-secondary);
    }
    .info-chip .value { color: var(--text); font-weight: 700; }

    .progress-section { margin-top: 14px; }
    .progress-bar-bg {
      width: 100%; height: 7px; background: var(--bg); border-radius: 4px;
      overflow: hidden; border: 1px solid var(--border);
    }
    .progress-bar-fill {
      height: 100%; background: linear-gradient(90deg, var(--accent), #7c6cff);
      border-radius: 4px; transition: width 0.6s cubic-bezier(0.22, 1, 0.36, 1);
    }
    .progress-label {
      display: flex; justify-content: space-between; margin-top: 8px;
      font-size: 12px; font-weight: 600; color: var(--text-dim);
    }
    .progress-label .pct { color: var(--accent); font-weight: 800; }

    .field { margin-bottom: 18px; }
    .field:last-child { margin-bottom: 0; }
    .field label { display: block; font-size: 13px; font-weight: 700; color: var(--text-secondary); margin-bottom: 7px; }
    .field label .hint { font-weight: 500; color: var(--text-dim); }
    .input-row { display: flex; gap: 12px; }
    .input-row .field { flex: 1; }

    .field input, .field input[type="text"] {
      width: 100%; padding: 13px 16px; background: var(--bg);
      border: 1.5px solid var(--border); border-radius: 10px; color: var(--text);
      font-family: 'Urbanist', sans-serif; font-size: 15px; font-weight: 600;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .field input::placeholder { color: var(--text-dim); font-weight: 500; }
    .field input:focus { outline: none; border-color: var(--border-focus); box-shadow: 0 0 0 3px var(--accent-glow); }

    .calc-preview {
      display: flex; align-items: center; gap: 8px; padding: 11px 16px;
      background: var(--accent-light); border: 1px solid rgba(80,70,229,0.15);
      border-radius: 10px; margin-top: 12px; font-size: 14px; font-weight: 600;
      color: var(--text-secondary); opacity: 0; transform: translateY(-4px);
      transition: opacity 0.3s, transform 0.3s;
    }
    .calc-preview.visible { opacity: 1; transform: translateY(0); }
    .calc-preview .calc-value { color: var(--accent); font-weight: 800; font-size: 16px; }

    .submit-btn {
      width: 100%; padding: 15px; background: var(--accent); color: #fff; border: none;
      border-radius: 12px; font-family: 'Urbanist', sans-serif; font-size: 15px;
      font-weight: 800; cursor: pointer; transition: transform 0.15s, box-shadow 0.2s;
      position: relative; overflow: hidden;
    }
    .submit-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 20px var(--accent-glow); }
    .submit-btn:active { transform: translateY(0); }
    .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
    .submit-btn.loading { color: transparent; }
    .submit-btn.loading::after {
      content: ''; position: absolute; width: 20px; height: 20px;
      border: 2.5px solid rgba(255,255,255,0.3); border-top-color: #fff;
      border-radius: 50%; top: 50%; left: 50%; margin: -10px 0 0 -10px;
      animation: spin 0.6s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .toast {
      position: fixed; bottom: 32px; left: 50%;
      transform: translateX(-50%) translateY(24px); padding: 13px 22px;
      border-radius: 12px; font-size: 14px; font-weight: 700; opacity: 0;
      transition: opacity 0.3s, transform 0.3s; pointer-events: none;
      z-index: 100; max-width: 90%; text-align: center;
    }
    .toast.visible { opacity: 1; transform: translateX(-50%) translateY(0); }
    .toast.success { background: var(--success-bg); border: 1px solid var(--success-border); color: var(--success); }
    .toast.error { background: var(--error-bg); border: 1px solid var(--error-border); color: var(--error); }

    .sessions-list { list-style: none; }
    .session-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 13px 0; border-bottom: 1px solid var(--border);
    }
    .session-item:last-child { border-bottom: none; }
    .session-left { display: flex; flex-direction: column; gap: 2px; }
    .session-date { font-size: 14px; font-weight: 700; }
    .session-book { font-size: 12px; font-weight: 500; color: var(--text-secondary); }
    .session-right { display: flex; gap: 16px; align-items: center; }
    .session-stat { text-align: right; }
    .session-stat .num { font-size: 14px; font-weight: 800; color: var(--accent); }
    .session-stat .label { font-size: 11px; font-weight: 600; color: var(--text-dim); }
    .empty-state { text-align: center; padding: 24px; color: var(--text-dim); font-size: 14px; font-weight: 500; }

    .config-banner {
      background: var(--error-bg); border: 1px solid var(--error-border);
      border-radius: 12px; padding: 14px 18px; margin-bottom: 14px;
      font-size: 13px; font-weight: 600; color: var(--error); line-height: 1.5;
    }
    .config-banner code { background: rgba(220,53,69,0.08); padding: 2px 6px; border-radius: 4px; font-size: 12px; }

    @media (max-width: 380px) {
      .input-row { flex-direction: column; gap: 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-icon">üìñ</div>
      <h1>Reading Tracker</h1>
      <p>Log your reading sessions</p>
    </div>

    <div id="configBanner" class="config-banner" style="display:none;">
      ‚ö†Ô∏è Set your <code>API_BASE</code> URL in the script section.
    </div>

    <div class="card">
      <div class="card-title">Select Book</div>
      <div class="book-selector">
        <select id="bookSelect"><option value="">Loading books...</option></select>
      </div>
      <div class="book-info" id="bookInfo" style="display:none;">
        <div class="info-chip"><span class="icon">üìÑ</span> <span id="totalPagesChip"><span class="value">‚Äî</span> pages</span></div>
        <div class="info-chip"><span class="icon">üìç</span> Last page: <span class="value" id="lastPageChip">‚Äî</span></div>
        <div class="info-chip"><span class="icon">‚≠ê</span> <span class="value" id="ratingChip">‚Äî</span></div>
      </div>
      <div class="progress-section" id="progressSection" style="display:none;">
        <div class="progress-bar-bg"><div class="progress-bar-fill" id="progressFill" style="width:0%"></div></div>
        <div class="progress-label">
          <span id="progressPages">0 / 0 pages</span>
          <span class="pct" id="progressPct">0%</span>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Log Session</div>
      <div class="field">
        <label>Date</label>
        <input type="date" id="dateInput" />
      </div>
      <div class="input-row">
        <div class="field">
          <label>Time spent <span class="hint">(HH:MM:SS)</span></label>
          <input type="text" id="timeInput" placeholder="00:45:00" maxlength="8" inputmode="numeric" />
        </div>
        <div class="field">
          <label>Page got to</label>
          <input type="number" id="endPageInput" placeholder="e.g. 186" min="1" />
        </div>
      </div>
      <div class="calc-preview" id="calcPreview">
        üìñ Pages this session: <span class="calc-value" id="calcPages">‚Äî</span>
      </div>
    </div>

    <button class="submit-btn" id="submitBtn">Save Session</button>

    <div class="card" style="margin-top: 14px;">
      <div class="card-title">Recent Sessions</div>
      <div id="recentSessions"><div class="empty-state">Loading...</div></div>
    </div>

    <div class="toast" id="toast"></div>
  </div>

<script>
// ============================================================
var API_BASE = "https://script.google.com/macros/s/AKfycbyoEsXTiQRtmyetVXhE_lRrCDs7SjJhBvzl9Jj_YcQdVW86wXv2CeNxXWrpBRIw70cZ/exec";
var API_KEY = "LS_Reading_tracker_2026";
// ============================================================

var books = [];
var lastPage = 0;
var totalPages = 0;

var elBookSelect   = document.getElementById("bookSelect");
var elBookInfo     = document.getElementById("bookInfo");
var elTotalPages   = document.getElementById("totalPagesChip");
var elLastPage     = document.getElementById("lastPageChip");
var elRating       = document.getElementById("ratingChip");
var elProgressSection = document.getElementById("progressSection");
var elProgressFill = document.getElementById("progressFill");
var elProgressPages = document.getElementById("progressPages");
var elProgressPct  = document.getElementById("progressPct");
var elDate         = document.getElementById("dateInput");
var elTime         = document.getElementById("timeInput");
var elEndPage      = document.getElementById("endPageInput");
var elCalcPreview  = document.getElementById("calcPreview");
var elCalcPages    = document.getElementById("calcPages");
var elSubmitBtn    = document.getElementById("submitBtn");
var elRecent       = document.getElementById("recentSessions");
var elToast        = document.getElementById("toast");
var elConfigBanner = document.getElementById("configBanner");

// ‚îÄ‚îÄ Auto-format time input (insert colons automatically) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
elTime.addEventListener("input", function(e) {
  var raw = elTime.value.replace(/[^\d]/g, ""); // strip non-digits
  var formatted = "";
  for (var i = 0; i < raw.length && i < 6; i++) {
    if (i === 2 || i === 4) formatted += ":";
    formatted += raw[i];
  }
  elTime.value = formatted;
});

// Prevent non-numeric keys except backspace/tab/arrow
elTime.addEventListener("keydown", function(e) {
  var allowed = ["Backspace", "Tab", "ArrowLeft", "ArrowRight", "Delete", "Home", "End"];
  if (allowed.indexOf(e.key) !== -1) return;
  if (e.key >= "0" && e.key <= "9") return;
  e.preventDefault();
});

function init() {
  elDate.value = new Date().toISOString().split("T")[0];

  if (!API_BASE || API_BASE === "PASTE_YOUR_WEB_APP_URL_HERE") {
    elConfigBanner.style.display = "block";
    elBookSelect.innerHTML = '<option value="">‚ö†Ô∏è Set your API_BASE URL first</option>';
    return;
  }

  loadBooks();
  loadRecentSessions();
}

async function apiGet(params) {
  var qs = new URLSearchParams(Object.assign({ key: API_KEY }, params)).toString();
  var res = await fetch(API_BASE + "?" + qs, { redirect: "follow" });
  if (!res.ok) throw new Error("HTTP " + res.status);
  return await res.json();
}

async function apiPost(payload) {
  var res = await fetch(API_BASE, {
    method: "POST",
    redirect: "follow",
    headers: { "Content-Type": "text/plain" },
    body: JSON.stringify(Object.assign({ key: API_KEY }, payload))
  });
  if (!res.ok) throw new Error("HTTP " + res.status);
  return await res.json();
}

async function loadBooks() {
  try {
    elBookSelect.innerHTML = '<option value="">Loading books...</option>';
    var data = await apiGet({ action: "books" });
    if (!data.ok) throw new Error(data.error || "API error");
    books = data.books;

    if (books.length === 0) {
      elBookSelect.innerHTML = '<option value="">No unfinished books found</option>';
      return;
    }

    var html = "";
    for (var i = 0; i < books.length; i++) {
      var b = books[i];
      html += '<option value="' + b.title + '" data-pages="' + b.total_pages +
        '" data-rating="' + (b.goodread_rating || "‚Äî") +
        '" data-read="' + (b.pages_read || 0) + '">' +
        b.title + ' ‚Äî ' + b.author + '</option>';
    }
    elBookSelect.innerHTML = html;
    await onBookChange();
  } catch (err) {
    console.error("loadBooks:", err);
    showToast("Error: " + err.message, "error");
    elBookSelect.innerHTML = '<option value="">Failed: ' + err.message + '</option>';
  }
}

async function onBookChange() {
  var title = elBookSelect.value;
  if (!title) {
    elBookInfo.style.display = "none";
    elProgressSection.style.display = "none";
    return;
  }

  var opt = elBookSelect.selectedOptions[0];
  totalPages = parseInt(opt.dataset.pages) || 0;
  var rating = opt.dataset.rating;

  try {
    var data = await apiGet({ action: "lastpage", book_title: title });
    lastPage = (data.ok) ? (data.last_page || 0) : (parseInt(opt.dataset.read) || 0);
  } catch (err) {
    lastPage = parseInt(opt.dataset.read) || 0;
  }

  elTotalPages.innerHTML = '<span class="value">' + totalPages + '</span> pages';
  elLastPage.textContent = lastPage;
  elRating.textContent = rating;
  elBookInfo.style.display = "flex";

  var pct = totalPages > 0 ? Math.round((lastPage / totalPages) * 100) : 0;
  elProgressFill.style.width = pct + "%";
  elProgressPages.textContent = lastPage + " / " + totalPages + " pages";
  elProgressPct.textContent = pct + "%";
  elProgressSection.style.display = "block";

  elCalcPreview.classList.remove("visible");
  elEndPage.value = "";
  elEndPage.placeholder = "e.g. " + (lastPage + 20);
}

function onEndPageInput() {
  var endPage = parseInt(elEndPage.value);
  if (!isNaN(endPage) && endPage > lastPage) {
    elCalcPages.textContent = endPage - lastPage;
    elCalcPreview.classList.add("visible");
  } else {
    elCalcPreview.classList.remove("visible");
  }
}

function parseTimeToSeconds(str) {
  var parts = str.trim().split(":").map(Number);
  if (parts.some(isNaN)) return NaN;
  if (parts.length === 3) return parts[0] * 3600 + parts[1] * 60 + parts[2];
  if (parts.length === 2) return parts[0] * 60 + parts[1];
  return NaN;
}

async function submit() {
  var title = elBookSelect.value;
  var date = elDate.value;
  var timeStr = elTime.value.trim();
  var endPage = parseInt(elEndPage.value);

  if (!title) return showToast("Select a book", "error");
  if (!date) return showToast("Select a date", "error");
  if (!timeStr) return showToast("Enter time spent", "error");
  if (isNaN(parseTimeToSeconds(timeStr))) return showToast("Invalid time. Use HH:MM:SS", "error");
  if (isNaN(endPage) || endPage <= 0) return showToast("Enter a valid page number", "error");
  if (endPage <= lastPage) return showToast("Page must be greater than " + lastPage, "error");
  if (endPage > totalPages) return showToast("Page can't exceed " + totalPages, "error");

  var pagesRead = endPage - lastPage;
  var seconds = parseTimeToSeconds(timeStr);

  elSubmitBtn.disabled = true;
  elSubmitBtn.classList.add("loading");

  try {
    var data = await apiPost({
      action: "log_reading",
      date: date,
      title: title,
      time_spent: timeStr,
      pages_read: pagesRead,
      seconds: seconds
    });

    if (!data.ok) throw new Error(data.error || "Failed to save");

    showToast("Saved! " + pagesRead + " pages of \"" + title + "\"", "success");

    lastPage = endPage;
    elLastPage.textContent = lastPage;
    var pct = totalPages > 0 ? Math.round((lastPage / totalPages) * 100) : 0;
    elProgressFill.style.width = pct + "%";
    elProgressPages.textContent = lastPage + " / " + totalPages + " pages";
    elProgressPct.textContent = pct + "%";

    elTime.value = "";
    elEndPage.value = "";
    elEndPage.placeholder = "e.g. " + (lastPage + 20);
    elCalcPreview.classList.remove("visible");

    loadRecentSessions();
  } catch (err) {
    showToast(err.message, "error");
  } finally {
    elSubmitBtn.disabled = false;
    elSubmitBtn.classList.remove("loading");
  }
}

async function loadRecentSessions() {
  try {
    var data = await apiGet({ action: "recent", limit: 5 });
    if (!data.ok) throw new Error(data.error);
    renderRecentSessions(data.sessions || []);
  } catch (err) {
    elRecent.innerHTML = '<div class="empty-state">Could not load sessions</div>';
  }
}

function renderRecentSessions(sessions) {
  if (sessions.length === 0) {
    elRecent.innerHTML = '<div class="empty-state">No sessions yet. Start reading!</div>';
    return;
  }

  var html = '<ul class="sessions-list">';
  for (var i = 0; i < sessions.length; i++) {
    var s = sessions[i];
    html += '<li class="session-item">' +
      '<div class="session-left">' +
        '<span class="session-date">' + formatDate(s.date) + '</span>' +
        '<span class="session-book">' + s.title + '</span>' +
      '</div>' +
      '<div class="session-right">' +
        '<div class="session-stat"><div class="num">' + s.pages_read + '</div><div class="label">pages</div></div>' +
        '<div class="session-stat"><div class="num">' + s.time_spent + '</div><div class="label">time</div></div>' +
      '</div></li>';
  }
  html += '</ul>';
  elRecent.innerHTML = html;
}

function formatDate(dateStr) {
  if (!dateStr || dateStr === "Invalid Date") return "‚Äî";
  try {
    var parts = dateStr.split("-");
    if (parts.length === 3) {
      var d = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
      return d.toLocaleDateString("en-GB", { day: "numeric", month: "short", year: "numeric" });
    }
    return dateStr;
  } catch (e) {
    return dateStr;
  }
}

function showToast(message, type) {
  elToast.textContent = message;
  elToast.className = "toast " + type + " visible";
  clearTimeout(showToast._timer);
  showToast._timer = setTimeout(function() {
    elToast.classList.remove("visible");
  }, 3500);
}

elBookSelect.addEventListener("change", onBookChange);
elEndPage.addEventListener("input", onEndPageInput);
elSubmitBtn.addEventListener("click", submit);
document.addEventListener("keydown", function(e) {
  if (e.key === "Enter" && !elSubmitBtn.disabled) submit();
});

init();
</script>
</body>
</html>
