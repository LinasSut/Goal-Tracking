<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reading Tracker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #ffffff;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      -webkit-font-smoothing: antialiased;
      font-family: 'Manrope', sans-serif;
    }
    .container { width: 520px; }

    /* ‚îÄ‚îÄ PIN Screen ‚îÄ‚îÄ */
    .pin-screen {
      display: flex; flex-direction: column; align-items: center;
      justify-content: center; min-height: 60vh; text-align: center;
      width: 520px;
    }
    .pin-header {
      width: 100%; display: flex; align-items: flex-start; justify-content: space-between;
    }
    .pin-header-title { font-size: 11px; font-weight: 800; letter-spacing: 4px; text-transform: uppercase; color: #1a1a1a; }
    .pin-header-sub { font-size: 11px; font-weight: 600; color: #999; }
    .pin-sep { width: 100%; height: 2px; background: #5046e5; margin-top: 16px; margin-bottom: 60px; }
    .pin-label {
      font-size: 9px; font-weight: 800; text-transform: uppercase;
      letter-spacing: 2px; color: #ccc; margin-bottom: 14px;
    }
    .pin-wrap { display: flex; gap: 10px; margin-bottom: 12px; }
    .pin-wrap input {
      width: 42px; height: 52px; text-align: center;
      font-family: 'Manrope', sans-serif; font-size: 20px; font-weight: 800;
      background: transparent; border: none; border-bottom: 2px solid #e8e6e1;
      color: #1a1a1a; -webkit-text-security: disc; transition: border-color 0.2s;
    }
    .pin-wrap input:focus { outline: none; border-bottom-color: #5046e5; }
    .pin-wrap input.error { border-bottom-color: #dc3545; animation: shake 0.4s ease; }
    @keyframes shake {
      0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px)}
      50%{transform:translateX(5px)} 75%{transform:translateX(-3px)}
    }
    .pin-status { font-size: 12px; font-weight: 700; color: #dc3545; min-height: 18px; margin-top: 4px; }

    /* ‚îÄ‚îÄ App ‚îÄ‚îÄ */
    .app { display: none; }
    .app.visible { display: block; }

    .header { display: flex; align-items: flex-start; justify-content: space-between; }
    .title { font-size: 11px; font-weight: 800; letter-spacing: 4px; text-transform: uppercase; color: #1a1a1a; }
    .date-display { font-size: 11px; font-weight: 600; color: #999; }
    .header-sep { width: 100%; height: 2px; background: #5046e5; margin-top: 16px; margin-bottom: 24px; }

    /* Book section */
    .book-section { display: none; gap: 20px; margin-bottom: 18px; }
    .book-section.visible { display: flex; }
    .book-cover {
      width: 100px; height: 150px; border-radius: 2px; overflow: hidden;
      flex-shrink: 0; background: #f4f3f0;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 2px 2px 12px rgba(0,0,0,0.08);
    }
    .book-cover img { width: 100%; height: 100%; object-fit: cover; }
    .book-cover .placeholder { font-size: 32px; color: #ddd; }

    .book-meta { flex: 1; display: flex; flex-direction: column; justify-content: center; }
    .book-name { font-size: 18px; font-weight: 800; color: #1a1a1a; line-height: 1.2; }
    .book-author { font-size: 12px; font-weight: 500; color: #aaa; margin-top: 3px; margin-bottom: 14px; }
    .chips { display: flex; gap: 8px; flex-wrap: wrap; }
    .chip {
      font-size: 11px; font-weight: 700; padding: 5px 12px; border-radius: 2px;
      background: #f6f5f2; color: #888; display: flex; align-items: center; gap: 5px;
    }
    .chip .num { font-weight: 800; color: #1a1a1a; }
    .chip.accent { background: #ededfc; color: #5046e5; }
    .chip.accent .num { color: #5046e5; }

    /* Progress */
    .progress-row { display: none; align-items: center; gap: 12px; margin-bottom: 24px; }
    .progress-row.visible { display: flex; }
    .progress-bar { flex: 1; height: 4px; background: #f0ece4; }
    .progress-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #5046e5, #7c6cff); transition: width 0.6s ease; }
    .progress-pct { font-size: 12px; font-weight: 800; color: #5046e5; min-width: 36px; text-align: right; }

    /* Select */
    .select {
      width: 100%; padding: 12px 14px; border: none;
      border-bottom: 2px solid #e8e6e1; font-family: 'Manrope', sans-serif;
      font-size: 14px; font-weight: 700; color: #1a1a1a;
      background: transparent; appearance: none; cursor: pointer; margin-bottom: 24px;
      transition: border-color 0.2s;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath d='M3 4.5L6 7.5L9 4.5' stroke='%23999' stroke-width='1.5' fill='none'/%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: right 4px center;
    }
    .select:focus { outline: none; border-bottom-color: #5046e5; }

    /* Input grid */
    .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0; margin-bottom: 28px; }
    .field { padding: 0 12px; border-right: 1px solid #eee; }
    .field:first-child { padding-left: 0; }
    .field:last-child { border-right: none; padding-right: 0; }
    .field label {
      display: block; font-size: 9px; font-weight: 800;
      text-transform: uppercase; letter-spacing: 2px; color: #ccc; margin-bottom: 6px;
    }
    .field input {
      width: 100%; padding: 8px 0; border: none;
      border-bottom: 1px solid #e8e6e1; font-family: 'Manrope', sans-serif;
      font-size: 15px; font-weight: 700; color: #1a1a1a;
      background: transparent; transition: border-color 0.2s;
    }
    .field input:focus { outline: none; border-bottom-color: #5046e5; }
    .field input::placeholder { color: #ddd; font-weight: 500; }

    /* Footer */
    .footer { display: flex; align-items: center; justify-content: space-between; }
    .calc-wrap { display: flex; flex-direction: column; opacity: 0; transform: translateY(-4px); transition: all 0.3s; }
    .calc-wrap.visible { opacity: 1; transform: translateY(0); }
    .calc-value { font-size: 24px; font-weight: 800; color: #5046e5; }
    .calc-label { font-size: 10px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: #ccc; }
    .footer-actions { display: flex; align-items: center; gap: 14px; }
    .lock-btn {
      width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
      background: transparent; border: 1.5px solid #e8e6e1; border-radius: 4px;
      font-size: 16px; cursor: pointer; transition: all 0.2s; color: #bbb;
    }
    .lock-btn:hover { border-color: #999; color: #666; }
    .btn {
      padding: 12px 32px; background: #5046e5; color: white; border: none;
      font-family: 'Manrope', sans-serif; font-size: 12px; font-weight: 800;
      letter-spacing: 2px; text-transform: uppercase; cursor: pointer;
      transition: all 0.2s; box-shadow: 0 4px 12px rgba(80,70,229,0.2);
      position: relative; overflow: hidden;
    }
    .btn:hover { background: #4038c7; transform: translateY(-1px); box-shadow: 0 6px 20px rgba(80,70,229,0.3); }
    .btn:active { transform: translateY(0); }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; box-shadow: none; }
    .btn.loading { color: transparent; }
    .btn.loading::after {
      content: ''; position: absolute; width: 16px; height: 16px;
      border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff;
      border-radius: 50%; top: 50%; left: 50%; margin: -8px 0 0 -8px;
      animation: spin 0.6s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Toast */
    .toast {
      position: fixed; bottom: 32px; left: 50%;
      transform: translateX(-50%) translateY(20px); padding: 12px 24px;
      border-radius: 4px; font-size: 13px; font-weight: 700; opacity: 0;
      transition: all 0.3s; pointer-events: none; z-index: 100; max-width: 90%; text-align: center;
    }
    .toast.visible { opacity: 1; transform: translateX(-50%) translateY(0); }
    .toast.success { background: #edf8f3; border: 1px solid #c8eddb; color: #16a06e; }
    .toast.error { background: #fdf0f1; border: 1px solid #f5c6cb; color: #dc3545; }

    @media (max-width: 560px) {
      .container, .pin-screen { width: 100%; }
      .book-section { flex-direction: column; align-items: center; text-align: center; }
      .book-meta { align-items: center; }
      .chips { justify-content: center; }
      .grid { grid-template-columns: 1fr; gap: 16px; }
      .field { padding: 0; border-right: none; }
    }
  </style>
</head>
<body>
  <div class="container">

    <!-- PIN Screen -->
    <div id="pinScreen" class="pin-screen">
      <div class="pin-header">
        <div class="pin-header-title">Log Reading</div>
        <div class="pin-header-sub">üîí Locked</div>
      </div>
      <div class="pin-sep"></div>
      <div class="pin-label">Enter 6-digit PIN</div>
      <div class="pin-wrap" id="pinWrap">
        <input type="text" maxlength="1" inputmode="numeric" class="pin-char" data-idx="0" autofocus />
        <input type="text" maxlength="1" inputmode="numeric" class="pin-char" data-idx="1" />
        <input type="text" maxlength="1" inputmode="numeric" class="pin-char" data-idx="2" />
        <input type="text" maxlength="1" inputmode="numeric" class="pin-char" data-idx="3" />
        <input type="text" maxlength="1" inputmode="numeric" class="pin-char" data-idx="4" />
        <input type="text" maxlength="1" inputmode="numeric" class="pin-char" data-idx="5" />
      </div>
      <div class="pin-status" id="pinStatus"></div>
    </div>

    <!-- App -->
    <div id="app" class="app">
      <div class="header">
        <div class="title">Log Reading</div>
        <div class="date-display" id="headerDate"></div>
      </div>
      <div class="header-sep"></div>

      <div class="book-section" id="bookSection">
        <div class="book-cover" id="bookCover"><span class="placeholder">üìñ</span></div>
        <div class="book-meta">
          <div class="book-name" id="bookName"></div>
          <div class="book-author" id="bookAuthor"></div>
          <div class="chips">
            <div class="chip"><span class="num" id="chipTotal">‚Äî</span> pages</div>
            <div class="chip">Page <span class="num" id="chipCurrent">‚Äî</span></div>
            <div class="chip"><span class="num" id="chipLeft">‚Äî</span> left</div>
            <div class="chip accent">‚≠ê <span class="num" id="chipRating">‚Äî</span></div>
          </div>
        </div>
      </div>

      <div class="progress-row" id="progressRow">
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        <div class="progress-pct" id="progressPct">0%</div>
      </div>

      <select class="select" id="bookSelect"><option value="">Loading...</option></select>

      <div class="grid">
        <div class="field"><label>Date</label><input type="date" id="dateInput" /></div>
        <div class="field"><label>Time</label><input type="text" id="timeInput" placeholder="00:45:00" maxlength="8" inputmode="numeric" /></div>
        <div class="field"><label>Page</label><input type="number" id="endPageInput" placeholder="204" min="1" /></div>
      </div>

      <div class="footer">
        <div class="calc-wrap" id="calcWrap">
          <div class="calc-value" id="calcPages">‚Äî</div>
          <div class="calc-label">Pages read</div>
        </div>
        <div class="footer-actions">
          <button class="lock-btn" id="lockBtn">üîí</button>
          <button class="btn" id="submitBtn">Save</button>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>
  </div>

<script>
var API_BASE = "https://script.google.com/macros/s/AKfycbyoEsXTiQRtmyetVXhE_lRrCDs7SjJhBvzl9Jj_YcQdVW86wXv2CeNxXWrpBRIw70cZ/exec";
var API_KEY = "LS_Reading_tracker_2026";
var userPin = "", books = [], lastPage = 0, totalPages = 0;

var $ = function(id) { return document.getElementById(id); };
var elPinScreen = $("pinScreen"), elApp = $("app"), elPinStatus = $("pinStatus");
var pinInputs = document.querySelectorAll(".pin-char");
var elBookSection = $("bookSection"), elBookCover = $("bookCover");
var elBookName = $("bookName"), elBookAuthor = $("bookAuthor");
var elChipTotal = $("chipTotal"), elChipCurrent = $("chipCurrent");
var elChipLeft = $("chipLeft"), elChipRating = $("chipRating");
var elProgressRow = $("progressRow"), elProgressFill = $("progressFill"), elProgressPct = $("progressPct");
var elBookSelect = $("bookSelect"), elDate = $("dateInput");
var elTime = $("timeInput"), elEndPage = $("endPageInput");
var elCalcWrap = $("calcWrap"), elCalcPages = $("calcPages");
var elSubmitBtn = $("submitBtn"), elToast = $("toast");

$("headerDate").textContent = new Date().toLocaleDateString("en-GB", { day: "numeric", month: "short", year: "numeric" });

// ‚îÄ‚îÄ PIN ‚îÄ‚îÄ
var savedPin = localStorage.getItem("reading_tracker_pin");
if (savedPin) { userPin = savedPin; unlockApp(); }

pinInputs.forEach(function(input, idx) {
  input.addEventListener("input", function() {
    var val = input.value.replace(/[^\d]/g, "");
    input.value = val.slice(0, 1);
    if (val && idx < 5) pinInputs[idx + 1].focus();
    var full = ""; pinInputs.forEach(function(inp) { full += inp.value; });
    if (full.length === 6) verifyPin(full);
  });
  input.addEventListener("keydown", function(e) {
    if (e.key === "Backspace" && !input.value && idx > 0) { pinInputs[idx - 1].focus(); pinInputs[idx - 1].value = ""; }
    if (e.key.length === 1 && (e.key < "0" || e.key > "9")) e.preventDefault();
  });
  input.addEventListener("paste", function(e) {
    e.preventDefault();
    var p = (e.clipboardData || window.clipboardData).getData("text").replace(/[^\d]/g, "");
    for (var i = 0; i < 6 && i < p.length; i++) pinInputs[i].value = p[i];
    if (p.length >= 6) { pinInputs[5].focus(); verifyPin(p.slice(0, 6)); }
    else if (p.length > 0) pinInputs[Math.min(p.length, 5)].focus();
  });
});

async function verifyPin(pin) {
  elPinStatus.textContent = "Verifying..."; elPinStatus.style.color = "#999";
  try {
    var qs = new URLSearchParams({ key: API_KEY, pin: pin, action: "init", recent_limit: 5 }).toString();
    var data = await (await fetch(API_BASE + "?" + qs, { redirect: "follow" })).json();
    if (data.ok) {
      userPin = pin; localStorage.setItem("reading_tracker_pin", pin);
      elPinScreen.style.display = "none"; elApp.classList.add("visible");
      initAppWithData(data);
    } else if (data.error === "Invalid PIN") showPinError("Wrong PIN");
    else showPinError(data.error || "Error");
  } catch (err) { showPinError("Connection error"); }
}

function showPinError(msg) {
  elPinStatus.textContent = msg; elPinStatus.style.color = "#dc3545";
  pinInputs.forEach(function(inp) { inp.classList.add("error"); });
  setTimeout(function() {
    pinInputs.forEach(function(inp) { inp.value = ""; inp.classList.remove("error"); });
    pinInputs[0].focus(); elPinStatus.textContent = "";
  }, 900);
}

function unlockApp() {
  elPinScreen.style.display = "none"; elApp.classList.add("visible"); initApp();
}

$("lockBtn").addEventListener("click", function() {
  localStorage.removeItem("reading_tracker_pin");
  userPin = ""; pinInputs.forEach(function(inp) { inp.value = ""; });
  elPinScreen.style.display = "flex"; elApp.classList.remove("visible");
  elPinStatus.textContent = ""; pinInputs[0].focus();
});

// ‚îÄ‚îÄ Time auto-format ‚îÄ‚îÄ
elTime.addEventListener("input", function() {
  var raw = elTime.value.replace(/[^\d]/g, ""), f = "";
  for (var i = 0; i < raw.length && i < 6; i++) { if (i === 2 || i === 4) f += ":"; f += raw[i]; }
  elTime.value = f;
});
elTime.addEventListener("keydown", function(e) {
  if (["Backspace","Tab","ArrowLeft","ArrowRight","Delete","Home","End"].indexOf(e.key) !== -1) return;
  if (e.key >= "0" && e.key <= "9") return;
  e.preventDefault();
});

// ‚îÄ‚îÄ App init ‚îÄ‚îÄ
async function initApp() {
  elDate.value = new Date().toISOString().split("T")[0];
  try {
    var data = await apiGet({ action: "init", recent_limit: 5 });
    if (data.ok) initAppWithData(data); else throw new Error(data.error);
  } catch (err) { showToast("Error: " + err.message, "error"); }
}

function initAppWithData(data) {
  elDate.value = new Date().toISOString().split("T")[0];
  books = data.books || [];
  if (!books.length) {
    elBookSelect.innerHTML = '<option value="">No unfinished books</option>';
  } else {
    elBookSelect.innerHTML = books.map(function(b, i) {
      return '<option value="' + b.title + '" data-idx="' + i + '">' + b.title + ' ‚Äî ' + b.author + '</option>';
    }).join("");
  }
  if (books.length > 0) showBookInfo(books[0]);
}

function showBookInfo(book) {
  totalPages = book.total_pages;
  lastPage = book.pages_read || 0;

  // Cover
  if (book.cover_url) {
    elBookCover.innerHTML = '<img src="' + book.cover_url + '" alt="' + book.title + '" onerror="this.parentElement.innerHTML=\'<span class=placeholder>üìñ</span>\'" />';
  } else {
    elBookCover.innerHTML = '<span class="placeholder">üìñ</span>';
  }

  // Info
  elBookName.textContent = book.title;
  elBookAuthor.textContent = book.author;
  elBookSection.classList.add("visible");

  // Chips
  elChipTotal.textContent = totalPages;
  elChipCurrent.textContent = lastPage;
  elChipLeft.textContent = Math.max(0, totalPages - lastPage);
  elChipRating.textContent = book.goodread_rating || "‚Äî";

  // Progress
  var pct = totalPages > 0 ? Math.round((lastPage / totalPages) * 100) : 0;
  elProgressFill.style.width = pct + "%";
  elProgressPct.textContent = pct + "%";
  elProgressRow.classList.add("visible");

  // Reset
  elCalcWrap.classList.remove("visible");
  elEndPage.value = "";
  elEndPage.placeholder = String(Math.min(lastPage + 20, totalPages));
}

// ‚îÄ‚îÄ Events ‚îÄ‚îÄ
elBookSelect.addEventListener("change", function() {
  var title = elBookSelect.value;
  if (!title) {
    elBookSection.classList.remove("visible");
    elProgressRow.classList.remove("visible");
    return;
  }
  var book = books.find(function(b) { return b.title === title; });
  if (book) showBookInfo(book);
});

elEndPage.addEventListener("input", function() {
  var ep = parseInt(elEndPage.value);
  if (!isNaN(ep) && ep > lastPage) {
    elCalcPages.textContent = ep - lastPage;
    elCalcWrap.classList.add("visible");
  } else elCalcWrap.classList.remove("visible");
});

// ‚îÄ‚îÄ API helpers ‚îÄ‚îÄ
function parseTime(str) {
  var p = str.trim().split(":").map(Number);
  if (p.some(isNaN)) return NaN;
  if (p.length === 3) return p[0] * 3600 + p[1] * 60 + p[2];
  if (p.length === 2) return p[0] * 60 + p[1];
  return NaN;
}

async function apiGet(params) {
  params.pin = userPin;
  var qs = new URLSearchParams(Object.assign({ key: API_KEY }, params)).toString();
  return await (await fetch(API_BASE + "?" + qs, { redirect: "follow" })).json();
}

async function apiPost(payload) {
  payload.pin = userPin;
  return await (await fetch(API_BASE, {
    method: "POST", redirect: "follow", headers: { "Content-Type": "text/plain" },
    body: JSON.stringify(Object.assign({ key: API_KEY }, payload))
  })).json();
}

// ‚îÄ‚îÄ Submit ‚îÄ‚îÄ
async function submit() {
  var title = elBookSelect.value, date = elDate.value;
  var timeStr = elTime.value.trim(), endPage = parseInt(elEndPage.value);
  if (!title) return showToast("Select a book", "error");
  if (!date) return showToast("Select a date", "error");
  if (!timeStr) return showToast("Enter time spent", "error");
  if (isNaN(parseTime(timeStr))) return showToast("Invalid time format", "error");
  if (isNaN(endPage) || endPage <= 0) return showToast("Enter a valid page", "error");
  if (endPage <= lastPage) return showToast("Page must be > " + lastPage, "error");
  if (endPage > totalPages) return showToast("Page can't exceed " + totalPages, "error");

  var pagesRead = endPage - lastPage, seconds = parseTime(timeStr);
  elSubmitBtn.disabled = true; elSubmitBtn.classList.add("loading");
  try {
    var data = await apiPost({
      action: "log_reading", date: date, title: title,
      time_spent: timeStr, pages_read: pagesRead, seconds: seconds
    });
    if (!data.ok) throw new Error(data.error || "Save failed");
    showToast(pagesRead + " pages saved", "success");

    // Update state
    lastPage = endPage;
    var book = books.find(function(b) { return b.title === title; });
    if (book) book.pages_read = lastPage;
    var pct = totalPages > 0 ? Math.round((lastPage / totalPages) * 100) : 0;
    elChipCurrent.textContent = lastPage;
    elChipLeft.textContent = Math.max(0, totalPages - lastPage);
    elProgressFill.style.width = pct + "%";
    elProgressPct.textContent = pct + "%";
    elTime.value = ""; elEndPage.value = "";
    elEndPage.placeholder = String(Math.min(lastPage + 20, totalPages));
    elCalcWrap.classList.remove("visible");
  } catch (err) { showToast(err.message, "error"); }
  finally { elSubmitBtn.disabled = false; elSubmitBtn.classList.remove("loading"); }
}

function showToast(msg, type) {
  elToast.textContent = msg;
  elToast.className = "toast " + type + " visible";
  clearTimeout(showToast._t);
  showToast._t = setTimeout(function() { elToast.classList.remove("visible"); }, 3000);
}

elSubmitBtn.addEventListener("click", submit);
document.addEventListener("keydown", function(e) {
  if (e.key === "Enter" && !elSubmitBtn.disabled && elApp.classList.contains("visible")) submit();
});
</script>
</body>
</html>
