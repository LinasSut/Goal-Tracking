// ============================================================
// Google Apps Script â€” Reading Tracker API (with 6-digit PIN)
// ============================================================

const CONFIG = {
  API_KEY: "LS_Reading_tracker_2026",
  PIN: "202026",  // Change this to your preferred 6-digit PIN
  BOOKS_TAB: "1. Reading - Books",
  LOG_TAB: "1.1. Reading - Input",
};

function doGet(e) {
  var params = e.parameter;
  if (params.key !== CONFIG.API_KEY) {
    return jsonResponse({ ok: false, error: "Invalid API key" });
  }
  if (params.pin !== CONFIG.PIN) {
    return jsonResponse({ ok: false, error: "Invalid PIN" });
  }
  var action = params.action;
  if (action === "books") return getBooks();
  if (action === "lastpage") return getLastPage(params.book_title);
  if (action === "recent") return getRecentSessions(parseInt(params.limit) || 5);
  return jsonResponse({ ok: false, error: "Unknown action: " + action });
}

function doPost(e) {
  var payload;
  try {
    payload = JSON.parse(e.postData.contents);
  } catch (err) {
    return jsonResponse({ ok: false, error: "Invalid JSON payload" });
  }
  if (payload.key !== CONFIG.API_KEY) {
    return jsonResponse({ ok: false, error: "Invalid API key" });
  }
  if (payload.pin !== CONFIG.PIN) {
    return jsonResponse({ ok: false, error: "Invalid PIN" });
  }
  if (payload.action === "log_reading") return logReading(payload);
  return jsonResponse({ ok: false, error: "Unknown action: " + payload.action });
}

function padZero(n) {
  return n < 10 ? "0" + n : String(n);
}

function formatDateValue(val) {
  if (val instanceof Date) {
    return Utilities.formatDate(val, Session.getScriptTimeZone(), "yyyy-MM-dd");
  }
  var s = String(val || "").trim();
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  var d = new Date(s);
  if (!isNaN(d.getTime()) && d.getFullYear() > 1900) {
    return Utilities.formatDate(d, Session.getScriptTimeZone(), "yyyy-MM-dd");
  }
  return s;
}

function formatTimeValue(val) {
  if (val instanceof Date) {
    return Utilities.formatDate(val, Session.getScriptTimeZone(), "HH:mm:ss");
  }
  if (typeof val === "number" && val >= 0 && val < 1) {
    var totalSec = Math.round(val * 86400);
    var h = Math.floor(totalSec / 3600);
    var m = Math.floor((totalSec % 3600) / 60);
    var s = totalSec % 60;
    return padZero(h) + ":" + padZero(m) + ":" + padZero(s);
  }
  var str = String(val || "").trim();
  if (/^\d{1,2}:\d{2}(:\d{2})?$/.test(str)) return str;
  var timeMatch = str.match(/(\d{2}):(\d{2}):(\d{2})/);
  if (timeMatch) return timeMatch[1] + ":" + timeMatch[2] + ":" + timeMatch[3];
  return str;
}

function getBooks() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var booksSheet = ss.getSheetByName(CONFIG.BOOKS_TAB);
  var logSheet = ss.getSheetByName(CONFIG.LOG_TAB);

  if (!booksSheet) {
    return jsonResponse({ ok: false, error: "Books tab not found: " + CONFIG.BOOKS_TAB });
  }

  var booksData = booksSheet.getDataRange().getValues();
  var booksHeaders = booksData[0].map(function(h) { return String(h).toLowerCase().trim(); });

  var pagesReadPerBook = {};
  if (logSheet && logSheet.getLastRow() >= 2) {
    var logData = logSheet.getDataRange().getValues();
    var logHeaders = logData[0].map(function(h) { return String(h).toLowerCase().trim(); });
    var titleCol = logHeaders.indexOf("title");
    var pagesCol = logHeaders.indexOf("pages_read");
    if (titleCol !== -1 && pagesCol !== -1) {
      for (var i = 1; i < logData.length; i++) {
        var t = String(logData[i][titleCol] || "").trim().toLowerCase();
        if (t) {
          pagesReadPerBook[t] = (pagesReadPerBook[t] || 0) + (Number(logData[i][pagesCol]) || 0);
        }
      }
    }
  }

  var books = [];
  for (var i = 1; i < booksData.length; i++) {
    var row = booksData[i];
    var title = String(row[booksHeaders.indexOf("title")] || "").trim();
    if (!title) continue;
    var totalPages = Number(row[booksHeaders.indexOf("total_pages")] || 0);
    var pagesRead = pagesReadPerBook[title.toLowerCase()] || 0;
    if (totalPages > 0 && pagesRead >= totalPages) continue;
    books.push({
      nr: row[booksHeaders.indexOf("nr")] || i,
      title: title,
      author: String(row[booksHeaders.indexOf("author")] || ""),
      total_pages: totalPages,
      pages_read: pagesRead,
      goodread_rating: row[booksHeaders.indexOf("goodread_rating")] || null,
      have_book: String(row[booksHeaders.indexOf("have_book")] || ""),
      price: row[booksHeaders.indexOf("price")] || null,
    });
  }

  return jsonResponse({ ok: true, books: books });
}

function getLastPage(bookTitle) {
  if (!bookTitle) {
    return jsonResponse({ ok: false, error: "Missing book_title parameter" });
  }
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var logSheet = ss.getSheetByName(CONFIG.LOG_TAB);
  if (!logSheet || logSheet.getLastRow() < 2) {
    return jsonResponse({ ok: true, last_page: 0 });
  }
  var data = logSheet.getDataRange().getValues();
  var headers = data[0].map(function(h) { return String(h).toLowerCase().trim(); });
  var titleCol = headers.indexOf("title");
  var pagesCol = headers.indexOf("pages_read");
  if (titleCol === -1 || pagesCol === -1) {
    return jsonResponse({ ok: true, last_page: 0 });
  }
  var totalPagesRead = 0;
  for (var i = 1; i < data.length; i++) {
    var rowTitle = String(data[i][titleCol] || "").trim();
    if (rowTitle.toLowerCase() === bookTitle.toLowerCase()) {
      totalPagesRead += Number(data[i][pagesCol]) || 0;
    }
  }
  return jsonResponse({ ok: true, last_page: totalPagesRead });
}

function logReading(payload) {
  var date = payload.date;
  var title = payload.title;
  var time_spent = payload.time_spent;
  var pages_read = payload.pages_read;
  var seconds = payload.seconds;
  if (!date) return jsonResponse({ ok: false, error: "Missing date" });
  if (!title) return jsonResponse({ ok: false, error: "Missing title" });
  if (!time_spent) return jsonResponse({ ok: false, error: "Missing time_spent" });
  if (!pages_read || pages_read <= 0) return jsonResponse({ ok: false, error: "Invalid pages_read" });
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var logSheet = ss.getSheetByName(CONFIG.LOG_TAB);
  if (!logSheet) {
    return jsonResponse({ ok: false, error: "Log tab not found: " + CONFIG.LOG_TAB });
  }
  logSheet.appendRow([date, title, "'" + time_spent, pages_read, seconds || 0]);
  return jsonResponse({
    ok: true, message: "Session logged",
    date: date, title: title, pages_read: pages_read, time_spent: time_spent
  });
}

function getRecentSessions(limit) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var logSheet = ss.getSheetByName(CONFIG.LOG_TAB);
  if (!logSheet || logSheet.getLastRow() < 2) {
    return jsonResponse({ ok: true, sessions: [] });
  }
  var data = logSheet.getDataRange().getValues();
  var displayData = logSheet.getDataRange().getDisplayValues();
  var headers = data[0].map(function(h) { return String(h).toLowerCase().trim(); });
  var dateCol = headers.indexOf("date");
  var titleColIdx = headers.indexOf("title");
  var timeCol = headers.indexOf("time_spent");
  var pagesColIdx = headers.indexOf("pages_read");
  var sessions = [];
  for (var i = 1; i < data.length; i++) {
    var title = String(data[i][titleColIdx] || "").trim();
    if (!title) continue;
    var dateVal = formatDateValue(data[i][dateCol]);
    var timeVal = displayData[i][timeCol];
    sessions.push({
      date: dateVal, title: title, time_spent: timeVal,
      pages_read: Number(data[i][pagesColIdx] || 0),
    });
  }
  var recent = sessions.reverse().slice(0, limit);
  return jsonResponse({ ok: true, sessions: recent });
}

function jsonResponse(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}
